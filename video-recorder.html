<!DOCTYPE html>
<html>
<head>
<script
	src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

<script src="https://www.webrtc-experiment.com/RecordRTC.js"></script>
<script src="https://www.webrtc-experiment.com/gif-recorder.js"></script>
<script src="https://www.webrtc-experiment.com/getScreenId.js"></script>
<script src="https://www.webrtc-experiment.com/DetectRTC.js">
	
</script>

<!-- for Edige/FF/Chrome/Opera/etc. getUserMedia support -->
<script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>
<!-- Latest compiled and minified CSS -->
<link rel="stylesheet"
	href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"
	integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u"
	crossorigin="anonymous">

<!-- Optional theme -->
<link rel="stylesheet"
	href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css"
	integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp"
	crossorigin="anonymous">

<!-- Latest compiled and minified JavaScript -->
<script
	src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"
	integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa"
	crossorigin="anonymous"></script>
</head>
<body>
	<button class="btn btn-primary" id="open-video-modal" data-target="#video-modal"
		data-toggle="modal">Start recording</button>
	<div class="modal fade" id="video-modal" tabindex="-1" role="dialog"
		aria-labelledby="exampleModalLabel" aria-hidden="true">
		<div class="modal-dialog" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="exampleModalLabel">Modal title</h5>
					<button type="button" class="close" data-dismiss="modal"
						aria-label="Close">
						<span aria-hidden="true">&times;</span>
					</button>
				</div>
				<div class="modal-body">
					<video controls autoplay playsinline muted=false volume=1
						class="video-tag" width="100%" height="100%"></video>
				</div>
				<div class="modal-footer">
					<button class="btn btn-secondary video-recording-button">Start
						Recording</button>
					<button class="btn btn-secondary stop-recording-button">Stop
						Recording</button>
					<button type="button" class="btn btn-primary" id="upload-to-server">Save
						changes</button>
				</div>
			</div>
		</div>
	</div>
	<style>
.d-none {
	display: none;
}
</style>
	 	<script>
		(function() {
			var params = {}, r = /([^&=]+)=?([^&]*)/g;

			function d(s) {
				return decodeURIComponent(s.replace(/\+/g, ' '));
			}

			var match, search = window.location.search;
			while (match = r.exec(search.substring(1))) {
				params[d(match[1])] = d(match[2]);

				if (d(match[2]) === 'true' || d(match[2]) === 'false') {
					params[d(match[1])] = d(match[2]) === 'true' ? true : false;
				}
			}

			window.params = params;
		})();
	</script>
	<script>
	var recordingPlayer = document.querySelector('.video-tag');

    //Open video modal and start capturing camera.
    document.getElementById("open-video-modal").addEventListener('click',function(){

            captureUserMedia({video: true, audio: true}, function(videoStream) {
            recordingPlayer.srcObject = videoStream;

            //recordingPlayer.src =videoStream;

        }, function(error) {
            alert('Could not access media devices');
            return false;
        });
    });

	/*SAVE VIDEO */
    function saveToDiskOrOpenNewTab(recordRTC) {
    /*    recordingDIV.querySelector('#save-to-disk').parentNode.style.display = 'block';
       recordingDIV.querySelector('#save-to-disk').onclick = function() {
           if(!recordRTC) return alert('No recording found.');

           recordRTC.save();
       };

       recordingDIV.querySelector('#open-new-tab').onclick = function() {
           if(!recordRTC) return alert('No recording found.');

           window.open(recordRTC.toURL());
       };

       if(isMyOwnDomain()) {
           recordingDIV.querySelector('#upload-to-server').disabled = true;
           recordingDIV.querySelector('#upload-to-server').style.display = 'none';
       }
       else {
           recordingDIV.querySelector('#upload-to-server').disabled = false;
       }
*/                
       $('#upload-to-server').on('click', function() {

           if(!recordRTC) return alert('No recording found.');
           this.disabled = true;

           var button = this;
           uploadToServer(recordRTC, function(progress, fileURL) {
               if(progress === 'ended') {
                   button.disabled = false;
                   /* button.innerHTML = 'Click to download from server';
                   button.onclick = function() {
                       window.open(fileURL);
                   }; */
                   return;
               }
               button.innerHTML = progress;
           });
       });
       
       //Upload  video to server
       function uploadToServer(recordRTC, callback) {
           var blob = recordRTC instanceof Blob ? recordRTC : recordRTC.blob;
           var fileType = blob.type.split('/')[0] || 'audio';
           var fileName = (Math.random() * 1000).toString().replace('.', '');

           if (fileType === 'audio') {
               fileName += '.' + (!!navigator.mozGetUserMedia ? 'ogg' : 'wav');
           } else {
               fileName += '.webm';
           }

           // create FormData
           var formData = new FormData();
           formData.append(fileType + '-filename', fileName);
           formData.append(fileType + '-blob', blob);

           callback('Uploading ' + fileType + ' recording to server.');

           // var upload_url = 'https://your-domain.com/files-uploader/';
           var upload_url = 'save.php';

           // var upload_directory = upload_url;
           var upload_directory = 'uploads/';

           makeXMLHttpRequest(upload_url, formData, function(progress) {
               if (progress !== 'upload-ended') {
                   callback(progress);
                   return;
               }

               callback('ended', upload_directory + fileName);

               // to make sure we can delete as soon as visitor leaves
               //listOfFilesUploaded.push(upload_directory + fileName);
           });
       }
       
       function makeXMLHttpRequest(url, data, callback) {
           var request = new XMLHttpRequest();
           request.onreadystatechange = function() {
               if (request.readyState == 4 && request.status == 200) {
                   callback('upload-ended');
               }
           };

           request.upload.onloadstart = function() {
               callback('Upload started...');
           };

           request.upload.onprogress = function(event) {
               callback('Upload Progress ' + Math.round(event.loaded / event.total * 100) + "%");
           };

           request.upload.onload = function() {
               callback('progress-about-to-end');
           };

           request.upload.onload = function() {
               callback('progress-ended');
           };

           request.upload.onerror = function(error) {
               callback('Failed to upload to server');
               console.error('XMLHttpRequest failed', error);
           };

           request.upload.onabort = function(error) {
               callback('Upload aborted.');
               console.error('XMLHttpRequest aborted', error);
           };

           request.open('POST', url);
           request.send(data);
       }
   }
    
    /*CAPTURE USER MEDIA DEVICES*/

    function captureUserMedia(mediaConstraints, successCallback, errorCallback) {
        navigator.mediaDevices.getUserMedia(mediaConstraints).then(successCallback).catch(errorCallback);
    }
    
    /*CAPTURING VIDEO*/

    function captureVideo(config) {
        captureUserMedia({video: true, audio: true}, function(videoStream) {
            recordingPlayer.srcObject = videoStream;

            config.onMediaCaptured(videoStream);

            videoStream.onended = function() {
                config.onMediaStopped();
            };
        }, function(error) {
            config.onMediaCapturingFailed(error);
        });
    }

    //CAPTURING VIDEO ENDS
    
		$('.video-recording-button').on('click', function() {
			var button = this;
			button.disable = true;
		    var commonConfig = {
		            onMediaCaptured: function(stream) {
		                button.stream = stream;
		                if(button.mediaCapturedCallback) {
		                    button.mediaCapturedCallback();
		                }

		                button.innerHTML = 'Stop Recording';
		                button.disabled = false;
		            },
		            onMediaStopped: function() {
		                button.innerHTML = 'Start Recording';

		                if(!button.disableStateWaiting) {
		                    button.disabled = false;
		                }
		            },
		            onMediaCapturingFailed: function(error) {
		                if(error.name === 'PermissionDeniedError' && !!navigator.mozGetUserMedia) {
		                    InstallTrigger.install({
		                        'Foo': {
		                            // https://addons.mozilla.org/firefox/downloads/latest/655146/addon-655146-latest.xpi?src=dp-btn-primary
		                            URL: 'https://addons.mozilla.org/en-US/firefox/addon/enable-screen-capturing/',
		                            toString: function () {
		                                return this.URL;
		                            }
		                        }
		                    });
		                }

		                commonConfig.onMediaStopped();
		            }
		        };
			captureVideo(commonConfig);
			
	        button.mediaCapturedCallback = function() {
                button.recordRTC = RecordRTC(button.stream, {
                    type: 'video',
                    // recorderType: 'MediaStreamRecorder',
                    disableLogs: false,
                    canvas: {
                        width: params.canvas_width || 320,
                        height: params.canvas_height || 240
                    },
                    frameInterval: typeof params.frameInterval !== 'undefined' ? parseInt(params.frameInterval) : 20 // minimum time between pushing frames to Whammy (in milliseconds)
                });

                button.recordingEndedCallback = function(url) {
                    recordingPlayer.src = null;
                    recordingPlayer.srcObject = null;
/* 
                    if(mediaContainerFormat.value === 'Gif') {
                        recordingPlayer.pause();
                        recordingPlayer.poster = url;
                        
                        recordingPlayer.onended = function() {
                            recordingPlayer.pause();
                            recordingPlayer.poster = URL.createObjectURL(button.recordRTC.blob);
                        };
                        return;
                    } */
                    console.log('here',url);
                    recordingPlayer.src = url;

                    recordingPlayer.onended = function() {
                        recordingPlayer.pause();
                        recordingPlayer.src = URL.createObjectURL(button.recordRTC.blob);
                    };
                };
                button.recordRTC.startRecording();
            };
		
            /*STOP RECORDING*/
              $('.stop-recording-button').on('click',function(){
            	  
                    button.disabled = true;
                    button.disableStateWaiting = true;
  /*                   setTimeout(function() {
                        button.disabled = false;
                        button.disableStateWaiting = false;
                    }, 2 * 1000);
 */
//                    button.innerHTML = 'Start Recording';

                    function stopStream() {
                        if(button.stream && button.stream.stop) {
                            button.stream.stop();
                            button.stream = null;
                        }
                    }

                    if(button.recordRTC) { 
                    console.log('here',button.recordRTC.length);                       
                        if(button.recordRTC.length) {
                            button.recordRTC[0].stopRecording(function(url) {
                                if(!button.recordRTC[1]) {
                                    button.recordingEndedCallback(url);
                                    stopStream();

                                    saveToDiskOrOpenNewTab(button.recordRTC[0]);
                                    return;
                                }

                                button.recordRTC[1].stopRecording(function(url) {
                                    button.recordingEndedCallback(url);
                                    stopStream();
                                });
                            });
                        }
                        else {
                            button.recordRTC.stopRecording(function(url) {
                                button.recordingEndedCallback(url);                                
                                stopStream();
                                saveToDiskOrOpenNewTab(button.recordRTC);
                            });
                        }
                    }

                    return;
              });
            
            
		});
	</script>

</body>
</html>
